apiVersion: v1
kind: ConfigMap
metadata:
  name: samba-config
  namespace: samba
  labels:
    app.kubernetes.io/name: samba
    app.kubernetes.io/component: configuration
data:
  smb.conf: |
    [global]
    workgroup = HOMELAB
    netbios name = k8s-samba
    security = user
    passdb backend = ldapsam:ldap://openldap-ldap.openldap.svc.cluster.local:389
    ldap suffix = dc=kojigenba-srv,dc=com
    ldap user suffix = ou=people
    ldap group suffix = ou=groups
    ldap admin dn = cn=admin,dc=kojigenba-srv,dc=com
    ldap passwd sync = yes
    ldap timeout = 10
    ldap ssl = off

    # DOS Attributes - Disable to avoid 0x80070032 errors on certain filesystems
    store dos attributes = no

    # Performance Optimization
    socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=8388608 SO_SNDBUF=8388608
    use sendfile = yes
    aio read size = 1048576
    aio write size = 1048576
    write cache size = 8388608
    read raw = yes
    write raw = yes
    max xmit = 16777216
    min receivefile size = 1048576
    getwd cache = yes
    strict allocate = no
    strict sync = no
    sync always = no
    kernel oplocks = no
    level2 oplocks = yes
    posix locking = no

    # SMB3 Performance
    server signing = disabled
    server multi channel support = yes
    deadtime = 15
    smb2 max read = 16777216
    smb2 max write = 16777216
    smb2 max trans = 16777216

    [shared]
    path = /mnt/shared
    comment = Shared Storage
    browseable = yes
    writable = yes
    create mask = 0600
    directory mask = 0700
    valid users = @samba-users

    [archive]
    path = /mnt/archive
    comment = Archive Storage
    browseable = yes
    writable = yes
    create mask = 0600
    directory mask = 0700
    valid users = @samba-users
