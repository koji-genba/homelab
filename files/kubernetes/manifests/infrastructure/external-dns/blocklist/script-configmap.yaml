apiVersion: v1
data:
  blocklist-downloader.sh: "#!/bin/bash\nset -e\necho \"=== External-Unbound Hagezi
    RPZ Downloader v3.0 ===\"\necho \"\U0001F552 Start time: $(date)\"\n\n# DNS Bootstrap
    solution\necho \"\U0001F527 Configuring DNS for package installation...\"\necho
    \"nameserver 1.1.1.1\" > /etc/resolv.conf\necho \"nameserver 8.8.8.8\" >> /etc/resolv.conf\n\necho
    \"\U0001F4E6 Installing dependencies...\"\napt-get update -qq >/dev/null 2>&1\napt-get
    install -y -qq curl ca-certificates >/dev/null 2>&1\n\necho \"\"\necho \"=== Downloading
    Hagezi DNS Blocklists (Complete Protection) ===\"\n\n# Create output directories\nmkdir
    -p /shared/rpz\nmkdir -p /shared/local-zones\n\n# Download statistics\nSUCCESS=0\nFAILED=0\nTOTAL_ENTRIES=0\n\n#
    Download function for RPZ files\ndownload_rpz() {\n  local name=\"$1\"\n  local
    url=\"$2\"\n  local filename=\"$3\"\n  local expected_entries=\"$4\"\n\n  echo
    -n \"\U0001F4E5 $name ($expected_entries entries)... \"\n  if curl -sL --connect-timeout
    30 --max-time 120 \"$url\" -o \"/shared/rpz/$filename\" 2>/dev/null; then\n    if
    [ -s \"/shared/rpz/$filename\" ]; then\n      local lines=$(wc -l < \"/shared/rpz/$filename\")\n
    \     local entries=$(grep -c \"CNAME \\.\" \"/shared/rpz/$filename\" 2>/dev/null
    || echo \"0\")\n      echo \"✅ ($lines lines, $entries block entries)\"\n      SUCCESS=$((SUCCESS
    + 1))\n      TOTAL_ENTRIES=$((TOTAL_ENTRIES + entries))\n      return 0\n    else\n
    \     echo \"❌ (empty file)\"\n      FAILED=$((FAILED + 1))\n      return 1\n
    \   fi\n  else\n    echo \"❌ (download failed)\"\n    FAILED=$((FAILED + 1))\n
    \   return 1\n  fi\n}\n\n# Download all Hagezi RPZ lists\ndownload_rpz \"Hagezi
    Pro Multi\" \\\n  \"https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/rpz/pro.txt\"
    \\\n  \"hagezi-pro.txt\" \"464,498\" || true\n\ndownload_rpz \"Hagezi TIF Full\"
    \\\n  \"https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/rpz/tif.txt\"
    \\\n  \"hagezi-tif.txt\" \"754,786\" || true\n\ndownload_rpz \"DoH/VPN/Proxy Bypass\"
    \\\n  \"https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/rpz/doh-vpn-proxy-bypass.txt\"
    \\\n  \"hagezi-doh-bypass.txt\" \"13,956\" || true\n\ndownload_rpz \"Dynamic DNS\"
    \\\n  \"https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/rpz/dyndns.txt\"
    \\\n  \"hagezi-dyndns.txt\" \"2,950\" || true\n\ndownload_rpz \"Badware Hoster\"
    \\\n  \"https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/rpz/hoster.txt\"
    \\\n  \"hagezi-badware.txt\" \"4,350\" || true\n\ndownload_rpz \"URL Shortener\"
    \\\n  \"https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/rpz/urlshortener.txt\"
    \\\n  \"hagezi-urlshortener.txt\" \"6,000\" || true\n\necho \"\"\necho \"\U0001F4CA
    Download Summary: $SUCCESS successful, $FAILED failed\"\necho \"\U0001F4CA Total
    RPZ entries: $TOTAL_ENTRIES (target: ~1.24M)\"\n\necho \"\"\necho \"=== Processing
    manual adjustment files ===\"\n\n# manual-blocklistとwhitelist ドメイン収集（RPZ処理前に実行）\necho
    \"\U0001F4DD Collecting manual domains for RPZ processing...\"\n\n# ブロックリストドメイン収集\nBLOCKLIST_DOMAINS=\"\"\nif
    [ -f \"/manual-config/manual-blocklist.txt\" ]; then\n  BLOCKLIST_DOMAINS=$(cat
    /manual-config/manual-blocklist.txt | \\\n    grep -v '^#' | grep -v '^$' | \\\n
    \   grep -E '^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$' | \\\n    sort -u)\n
    \ BLOCKLIST_COUNT=$(echo \"$BLOCKLIST_DOMAINS\" | grep -c '^' 2>/dev/null || echo
    \"0\")\n  echo \"   \U0001F4CB Blocklist domains collected: $BLOCKLIST_COUNT domains\"\nelse\n
    \ echo \"   \U0001F4CB No blocklist file found\"\nfi\n\n# ホワイトリストドメイン収集\nWHITELIST_DOMAINS=\"\"\nif
    [ -f \"/manual-config/manual-whitelist.txt\" ]; then\n  WHITELIST_DOMAINS=$(cat
    /manual-config/manual-whitelist.txt | \\\n    grep -v '^#' | grep -v '^$' | \\\n
    \   grep -E '^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$' | \\\n    sort -u)\n
    \ WHITELIST_COUNT=$(echo \"$WHITELIST_DOMAINS\" | grep -c '^' 2>/dev/null || echo
    \"0\")\n  echo \"   \U0001F4CB Whitelist domains collected: $WHITELIST_COUNT domains\"\nelse\n
    \ echo \"   \U0001F4CB No whitelist file found\"\nfi\n\n# RPZファイルの処理（ホワイトリスト除外とブロックリスト追加）\necho
    \"\U0001F4DD Processing RPZ files for manual adjustments...\"\nfor rpz_file in
    /shared/rpz/*.txt; do\n  if [ -f \"$rpz_file\" ]; then\n    ORIGINAL_COUNT=$(grep
    -c \"CNAME \\.\" \"$rpz_file\" 2>/dev/null || echo \"0\")\n    EXCLUDED_COUNT=0\n
    \   ADDED_COUNT=0\n\n    # ホワイトリストドメインを除外\n    if [ -n \"$WHITELIST_DOMAINS\"
    ] && [ \"$WHITELIST_COUNT\" -gt 0 ]; then\n      while IFS= read -r domain; do\n
    \       if [ -n \"$domain\" ]; then\n          # RPZファイルからドメインとそのサブドメインを除外\n          sed
    -i \"/^${domain} CNAME \\./d\" \"$rpz_file\" 2>/dev/null || true\n          sed
    -i \"/^\\*\\.${domain} CNAME \\./d\" \"$rpz_file\" 2>/dev/null || true\n        fi\n
    \     done <<< \"$WHITELIST_DOMAINS\"\n    fi\n\n    # ブロックリストドメインを追加（重複チェック付き）\n
    \   if [ -n \"$BLOCKLIST_DOMAINS\" ] && [ \"$BLOCKLIST_COUNT\" -gt 0 ]; then\n
    \     while IFS= read -r domain; do\n        if [ -n \"$domain\" ]; then\n          #
    既存チェック：重複を避ける\n          if ! grep -q \"^${domain} CNAME \\.\" \"$rpz_file\" 2>/dev/null;
    then\n            echo \"${domain} CNAME .\" >> \"$rpz_file\"\n            ADDED_COUNT=$((ADDED_COUNT
    + 1))\n          fi\n          if ! grep -q \"^\\*\\.${domain} CNAME \\.\" \"$rpz_file\"
    2>/dev/null; then\n            echo \"*.${domain} CNAME .\" >> \"$rpz_file\"\n
    \           ADDED_COUNT=$((ADDED_COUNT + 1))\n          fi\n        fi\n      done
    <<< \"$BLOCKLIST_DOMAINS\"\n    fi\n\n    # 統計情報表示\n    NEW_COUNT=$(grep -c \"CNAME
    \\.\" \"$rpz_file\" 2>/dev/null || echo \"0\")\n    EXCLUDED_COUNT=$((ORIGINAL_COUNT
    + ADDED_COUNT - NEW_COUNT))\n\n    if [ \"$EXCLUDED_COUNT\" -gt 0 ] || [ \"$ADDED_COUNT\"
    -gt 0 ]; then\n      echo \"   \U0001F4CB $(basename \"$rpz_file\"): excluded
    $EXCLUDED_COUNT, added $ADDED_COUNT entries\"\n    fi\n  fi\ndone\n\n# 注: Manual
    blocklist はRPZファイルに直接追加済み（上記処理で完了）\necho \"\U0001F4DD Manual blocklist processing
    complete (integrated with RPZ)\"\n\n# 手動ホワイトリスト処理（RPZのブロックを上書き）\necho \"\U0001F4DD
    Processing manual whitelist...\"\nif [ -f \"/manual-config/manual-whitelist.txt\"
    ]; then\n  MANUAL_WHITELISTED=$(cat /manual-config/manual-whitelist.txt | \\\n
    \   grep -v '^#' | grep -v '^$' | \\\n    grep -E '^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$'
    | \\\n    sort -u | wc -l)\n\n  if [ \"$MANUAL_WHITELISTED\" -gt 0 ]; then\n    echo
    \"# Manual Whitelist (from manual-whitelist.txt)\" > /shared/local-zones/manual-whitelist.conf\n
    \   cat /manual-config/manual-whitelist.txt | \\\n      grep -v '^#' | grep -v
    '^$' | \\\n      grep -E '^[a-zA-Z0-9][a-zA-Z0-9.-]*\\.[a-zA-Z]{2,}$' | \\\n      sort
    -u | while read -r domain; do\n        echo \"local-zone: \\\"${domain}.\\\" transparent\"\n
    \       echo \"\"\n      done >> /shared/local-zones/manual-whitelist.conf\n    echo
    \"   \U0001F4CB Manual whitelist: $MANUAL_WHITELISTED domains added\"\n  else\n
    \   echo \"   \U0001F4CB Manual whitelist: no valid domains found\"\n  fi\nelse\n
    \ echo \"   \U0001F4CB Manual whitelist: file not found, skipping\"\nfi\n\n# 手動DNSレコード処理\necho
    \"\U0001F4DD Processing manual DNS records...\"\nif [ -f \"/manual-config/manual-dns-records.txt\"
    ]; then\n  MANUAL_DNS_LINES=$(cat /manual-config/manual-dns-records.txt | \\\n
    \   grep -v '^#' | grep -v '^$' | wc -l)\n  if [ \"$MANUAL_DNS_LINES\" -gt 0 ];
    then\n    echo \"# Manual DNS Records (from manual-dns-records.txt)\" > /shared/local-zones/manual-dns-records.conf\n
    \   cat /manual-config/manual-dns-records.txt | \\\n      grep -v '^#' | grep
    -v '^$' >> /shared/local-zones/manual-dns-records.conf\n    echo \"   \U0001F4CB
    Manual DNS records: $MANUAL_DNS_LINES lines added\"\n  else\n    echo \"   \U0001F4CB
    Manual DNS records: file exists but no records found\"\n  fi\nelse\n  echo \"
    \  \U0001F4CB Manual DNS records: file not found, skipping\"\nfi\n\n# Set permissions\nchown
    -R root:root /shared/\nchmod -R 644 /shared/rpz/* /shared/local-zones/* 2>/dev/null
    || true\n\n# Final statistics\necho \"\"\necho \"=== Final Statistics ===\"\necho
    \"\U0001F4CA RPZ Files Downloaded: $SUCCESS of 6\"\necho \"\U0001F4CA Total Protected
    Entries: $TOTAL_ENTRIES domains\"\necho \"\U0001F4CA Target Achievement: $(echo
    \"scale=1; $TOTAL_ENTRIES/1240000*100\" | bc 2>/dev/null || echo \"~\")% of 1.24M
    target\"\necho \"\U0001F4CA RPZ Files: $(ls -1 /shared/rpz/*.txt 2>/dev/null |
    wc -l) files\"\necho \"\U0001F4CA Manual Configurations: $(ls -1 /shared/local-zones/*.conf
    2>/dev/null | wc -l) files\"\necho \"\U0001F4CA Total Storage: $(du -sh /shared/rpz/
    | cut -f1 2>/dev/null || echo \"unknown\")\"\necho \"\"\necho \"\U0001F6E1️  Protection
    Layers:\"\necho \"   ✅ Basic Protection: Hagezi Pro Multi\"\necho \"   ✅ Security
    Enhancement: TIF Full\"\necho \"   ✅ DNS Bypass Prevention: DoH/VPN/Proxy\"\necho
    \"   ✅ Dynamic DNS Protection: DynDNS\"\necho \"   ✅ Malicious Hosting: Badware
    Hoster\"\necho \"   ✅ URL Safety: Shortener Protection\"\necho \"\"\necho \"\U0001F3AF
    Complete RPZ-based DNS blocking with 6-layer protection\"\necho \"✅ Hagezi Complete
    Protection downloader finished\"\necho \"\"\n"
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: blocklist-downloader-script
  namespace: external-dns
