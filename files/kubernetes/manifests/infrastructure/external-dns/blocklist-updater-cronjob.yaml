apiVersion: batch/v1
kind: CronJob
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater
spec:
  schedule: "0 17 * * *"  # æ¯æ—¥ 17:00 UTC (æ—¥æœ¬æ™‚é–“ 2:00)
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 3600
  jobTemplate:
    metadata:
      labels:
        app: blocklist-updater
        component: updater-job
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 900  # 15åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      template:
        metadata:
          labels:
            app: blocklist-updater
            component: updater-pod
        spec:
          restartPolicy: Never
          
          # ServiceAccountè¨­å®šï¼ˆPodå‰Šé™¤æ¨©é™ï¼‰
          serviceAccountName: blocklist-updater
          
          containers:
          - name: updater
            image: bitnami/kubectl:latest
            command: ["/bin/bash"]
            args:
            - -c
            - |
              set -e
              echo "=== External-Unbound Hagezi RPZ Auto-Updater ==="
              echo "ğŸ•’ Update started at: $(date)"
              echo "ğŸ¯ Target: external-unbound deployment in external-dns namespace"
              echo "ğŸ›¡ï¸  Protection: Hagezi Complete Protection (6-layer RPZ)"
              echo ""
              
              # ç¾åœ¨ã®Podæƒ…å ±å–å¾—
              echo "ğŸ“‹ Current pod status:"
              kubectl get pods -n external-dns -l app=external-unbound -o wide
              
              # ç¾åœ¨ã®Hagezi RPZçŠ¶æ³ç¢ºèªï¼ˆãƒ­ã‚°ã‹ã‚‰å–å¾—ï¼‰
              echo ""
              echo "ğŸ“Š Current Hagezi RPZ status:"
              CURRENT_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "none")
              if [ "$CURRENT_POD" != "none" ]; then
                echo "   Pod: $CURRENT_POD"

                # Init Containerã‹ã‚‰ç·ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°å–å¾—
                TOTAL_ENTRIES=$(kubectl logs -n external-dns "$CURRENT_POD" -c blocklist-downloader 2>/dev/null | grep "ğŸ“Š Total Protected Entries:" | tail -1 | awk '{print $5}' 2>/dev/null || echo "unknown")
                echo "   Total Protected Entries: $TOTAL_ENTRIES"

                # RPZãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
                RPZ_FILES=$(kubectl logs -n external-dns "$CURRENT_POD" -c blocklist-downloader 2>/dev/null | grep "ğŸ“Š RPZ Files Downloaded:" | tail -1 | awk '{print $5}' 2>/dev/null || echo "unknown")
                echo "   RPZ Files Loaded: $RPZ_FILES of 6"

                POD_AGE=$(kubectl get pod -n external-dns "$CURRENT_POD" -o jsonpath='{.status.startTime}' 2>/dev/null || echo "unknown")
                echo "   Pod started: $POD_AGE"
              else
                echo "   No pods found!"
                exit 1
              fi
              
              echo ""
              echo "ğŸ”„ Triggering pod restart for blocklist update..."
              echo "   Method: Delete existing pods (Deployment will recreate automatically)"
              
              # Podå‰Šé™¤ï¼ˆDeploymentãŒè‡ªå‹•çš„ã«å†ä½œæˆï¼‰- CronJobè‡ªèº«ã¯é™¤å¤–
              kubectl delete pods -n external-dns -l app=external-unbound,version=v2.0 --wait=false
              
              echo "âœ… Pod deletion initiated"
              echo ""
              echo "â³ Waiting for DNS service to be ready..."
              echo "   Method: Simple pod status check"
              
              # Unboundã®PodçŠ¶æ…‹ç¢ºèª
              WAIT_COUNT=0
              MAX_WAIT=60  # æœ€å¤§10åˆ†ï¼ˆ10ç§’Ã—60å›ï¼‰
              
              while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
                WAIT_COUNT=$((WAIT_COUNT + 1))
                echo "   Checking pod status... (attempt $WAIT_COUNT/$MAX_WAIT)"
                
                # ReadyçŠ¶æ…‹ã®Unboundãƒãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if kubectl get pods -n external-dns -l app=external-unbound | grep -q "1/1.*Running"; then
                  echo "   âœ… DNS service pods are ready"
                  break
                fi
                
                sleep 10
              done
              
              if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
                echo "   âŒ DNS service failed to be ready after $((MAX_WAIT * 10)) seconds"
                exit 1
              fi
              
              # æ–°Podæƒ…å ±å–å¾—ï¼ˆçµ±è¨ˆè¡¨ç¤ºç”¨ï¼‰
              sleep 5
              NEW_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "unknown")
              
              # æ›´æ–°çµæœç¢ºèª
              echo ""
              echo "ğŸ‰ Update completed! New pod status:"
              kubectl get pods -n external-dns -l app=external-unbound -o wide
              
              # æ–°ã—ã„Hagezi RPZçŠ¶æ³ç¢ºèª
              echo ""
              echo "ğŸ“Š Updated Hagezi RPZ status:"
              NEW_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}')
              echo "   New Pod: $NEW_POD"

              # Init Containerãƒ­ã‚°ã‹ã‚‰çµ±è¨ˆå–å¾—ï¼ˆæ•°ç§’å¾…ã¤ï¼‰
              echo "   Waiting for init container completion..."
              sleep 30

              # æ–°Podã®Init ContainerãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
              kubectl wait --for=condition=Initialized pod "$NEW_POD" -n external-dns --timeout=300s >/dev/null 2>&1 || true

              # Hagezi RPZçµ±è¨ˆå–å¾—
              NEW_TOTAL_ENTRIES=$(kubectl logs -n external-dns "$NEW_POD" -c blocklist-downloader 2>/dev/null | grep "ğŸ“Š Total Protected Entries:" | tail -1 | awk '{print $5}' 2>/dev/null || echo "pending")
              NEW_RPZ_FILES=$(kubectl logs -n external-dns "$NEW_POD" -c blocklist-downloader 2>/dev/null | grep "ğŸ“Š RPZ Files Downloaded:" | tail -1 | awk '{print $5}' 2>/dev/null || echo "pending")

              echo "   New Total Protected Entries: $NEW_TOTAL_ENTRIES"
              echo "   New RPZ Files Loaded: $NEW_RPZ_FILES of 6"
              
              # DNSå‹•ä½œç¢ºèª
              echo ""
              echo "ğŸ” Verifying DNS functionality:"
              if kubectl exec -n external-dns "$NEW_POD" -- dig @127.0.0.1 -p 5353 google.com +short +time=5 | grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" >/dev/null 2>&1; then
                echo "   âœ… DNS resolution: Working"
              else
                echo "   âŒ DNS resolution: Failed"
                exit 1
              fi
              
              # ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ç¢ºèª
              if kubectl exec -n external-dns "$NEW_POD" -- dig @127.0.0.1 -p 5353 doubleclick.net +short +time=5 2>/dev/null | grep -E "(^$|NXDOMAIN|0\.0\.0\.0)" >/dev/null; then
                echo "   âœ… Ad blocking: Working"
              else
                echo "   âš ï¸  Ad blocking: Different response (may be normal)"
              fi
              
              echo ""
              echo "=== Hagezi RPZ Auto-update Summary ==="
              echo "ğŸ•’ Completed at: $(date)"
              echo "ğŸ“Š Previous Total Entries: $TOTAL_ENTRIES"
              echo "ğŸ“Š Updated Total Entries: $NEW_TOTAL_ENTRIES"
              echo "ğŸ“Š Previous RPZ Files: $RPZ_FILES of 6"
              echo "ğŸ“Š Updated RPZ Files: $NEW_RPZ_FILES of 6"
              echo "ğŸ¯ Pod: $CURRENT_POD â†’ $NEW_POD"
              echo "ğŸ›¡ï¸  Protection: Hagezi Complete (6-layer RPZ)"
              echo "âœ… Hagezi RPZ auto-update completed successfully"
              
            resources:
              requests:
                memory: "64Mi"
                cpu: "100m"
              limits:
                memory: "128Mi"
                cpu: "200m"
---
# ServiceAccount for CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater-sa
---
# ClusterRole with necessary permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: external-dns
  name: blocklist-updater
  labels:
    app: external-unbound
    component: updater-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "delete"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater-rb
subjects:
- kind: ServiceAccount
  name: blocklist-updater
  namespace: external-dns
roleRef:
  kind: Role
  name: blocklist-updater
  apiGroup: rbac.authorization.k8s.io