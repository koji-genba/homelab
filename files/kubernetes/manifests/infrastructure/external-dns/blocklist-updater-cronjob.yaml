apiVersion: batch/v1
kind: CronJob
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater
spec:
  schedule: "0 17 * * *"  # ÊØéÊó• 17:00 UTC (Êó•Êú¨ÊôÇÈñì 2:00)
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 3600
  jobTemplate:
    metadata:
      labels:
        app: blocklist-updater
        component: updater-job
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 900  # 15ÂàÜ„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
      template:
        metadata:
          labels:
            app: blocklist-updater
            component: updater-pod
        spec:
          restartPolicy: Never
          serviceAccountName: blocklist-updater

          volumes:
          - name: shared-data
            persistentVolumeClaim:
              claimName: blocklist-data
          - name: manual-config
            configMap:
              name: external-unbound-manual-config
              optional: true
          - name: scripts
            configMap:
              name: blocklist-downloader-script
              defaultMode: 0555

          initContainers:
          - name: blocklist-downloader
            image: ubuntu:24.04
            securityContext:
              runAsUser: 0
              allowPrivilegeEscalation: false
            command: ["/bin/bash"]
            args: ["/scripts/blocklist-downloader.sh"]
            volumeMounts:
            - name: shared-data
              mountPath: /shared
            - name: manual-config
              mountPath: /manual-config
              readOnly: true
            - name: scripts
              mountPath: /scripts
              readOnly: true
            resources:
              requests:
                memory: "500Mi"
                cpu: "250m"
              limits:
                memory: "1Gi"
                cpu: "500m"

          containers:
          - name: updater
            image: bitnami/kubectl:latest
            command: ["/bin/bash"]
            args:
            - -c
            - |
              set -e
              echo "=== External-Unbound Blocklist Updater ==="
              echo "üïí Update started at: $(date)"
              echo ""

              # Deployment „ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™çÔºàÂàùÊúüÂåñÊôÇ„ÅØÊú™„Éá„Éó„É≠„Ç§„ÅÆÂ†¥Âêà„Åå„ÅÇ„ÇãÔºâ
              if ! kubectl get deployment external-unbound -n external-dns >/dev/null 2>&1; then
                echo "‚ö†Ô∏è  Deployment external-unbound not found, skipping restart"
                echo "   (This is expected during initial setup)"
                echo "‚úÖ Blocklist data has been written to PVC"
                exit 0
              fi

              # ÁèæÂú®„ÅÆPodÊÉÖÂ†±ÂèñÂæó
              echo "üìã Current pod status:"
              kubectl get pods -n external-dns -l app=external-unbound -o wide
              echo ""

              # Rollout restart „Åß Pod ÂÜçËµ∑Âãï
              echo "üîÑ Triggering rollout restart..."
              kubectl rollout restart deployment/external-unbound -n external-dns

              echo "‚è≥ Waiting for rollout to complete..."
              kubectl rollout status deployment/external-unbound -n external-dns --timeout=300s

              # Êñ∞PodÊÉÖÂ†±ÂèñÂæó
              sleep 5
              NEW_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "unknown")
              echo ""
              echo "üéâ Rollout completed! New pod: $NEW_POD"
              kubectl get pods -n external-dns -l app=external-unbound -o wide
              echo ""

              # DNSÂãï‰ΩúÁ¢∫Ë™ç
              echo "üîç Verifying DNS functionality:"
              if kubectl exec -n external-dns "$NEW_POD" -- dig @127.0.0.1 -p 5353 google.com +short +time=5 2>/dev/null | grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" >/dev/null 2>&1; then
                echo "   ‚úÖ DNS resolution: Working"
              else
                echo "   ‚ùå DNS resolution: Failed"
                exit 1
              fi

              # „Éñ„É≠„ÉÉ„ÇØÊ©üËÉΩÁ¢∫Ë™ç
              if kubectl exec -n external-dns "$NEW_POD" -- dig @127.0.0.1 -p 5353 doubleclick.net +short +time=5 2>/dev/null | grep -E "(^$|NXDOMAIN|0\.0\.0\.0)" >/dev/null; then
                echo "   ‚úÖ Ad blocking: Working"
              else
                echo "   ‚ö†Ô∏è  Ad blocking: Different response (may be normal)"
              fi

              echo ""
              echo "üïí Completed at: $(date)"
              echo "‚úÖ Blocklist update completed successfully"

            resources:
              requests:
                memory: "64Mi"
                cpu: "100m"
              limits:
                memory: "128Mi"
                cpu: "200m"
---
# ServiceAccount for CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater-sa
---
# Role with necessary permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: external-dns
  name: blocklist-updater
  labels:
    app: external-unbound
    component: updater-role
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "patch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater-rb
subjects:
- kind: ServiceAccount
  name: blocklist-updater
  namespace: external-dns
roleRef:
  kind: Role
  name: blocklist-updater
  apiGroup: rbac.authorization.k8s.io
