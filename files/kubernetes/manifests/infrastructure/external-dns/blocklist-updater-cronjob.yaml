apiVersion: batch/v1
kind: CronJob
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater
spec:
  schedule: "0 2 * * *"  # ÊØéÊó• AM 2:00 UTC (Êó•Êú¨ÊôÇÈñì 11:00)
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 3600
  jobTemplate:
    metadata:
      labels:
        app: blocklist-updater
        component: updater-job
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 900  # 15ÂàÜ„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
      template:
        metadata:
          labels:
            app: blocklist-updater
            component: updater-pod
        spec:
          restartPolicy: Never
          
          # ServiceAccountË®≠ÂÆöÔºàPodÂâäÈô§Ê®©ÈôêÔºâ
          serviceAccountName: blocklist-updater
          
          containers:
          - name: updater
            image: bitnami/kubectl:latest
            command: ["/bin/bash"]
            args:
            - -c
            - |
              set -e
              echo "=== External-Unbound Blocklist Auto-Updater ==="
              echo "üïí Update started at: $(date)"
              echo "üéØ Target: external-unbound deployment in external-dns namespace"
              echo ""
              
              # ÁèæÂú®„ÅÆPodÊÉÖÂ†±ÂèñÂæó
              echo "üìã Current pod status:"
              kubectl get pods -n external-dns -l app=external-unbound -o wide
              
              # ÁèæÂú®„ÅÆ„Éñ„É≠„ÉÉ„ÇØÊï∞Á¢∫Ë™çÔºà„É≠„Ç∞„Åã„ÇâÂèñÂæóÔºâ
              echo ""
              echo "üìä Current blocklist status:"
              CURRENT_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "none")
              if [ "$CURRENT_POD" != "none" ]; then
                echo "   Pod: $CURRENT_POD"
                BLOCKED_DOMAINS=$(kubectl logs -n external-dns "$CURRENT_POD" -c unbound | grep "üìä Blocked domains:" | tail -1 | awk '{print $4}' 2>/dev/null || echo "unknown")
                echo "   Blocked domains: $BLOCKED_DOMAINS"
                POD_AGE=$(kubectl get pod -n external-dns "$CURRENT_POD" -o jsonpath='{.status.startTime}' 2>/dev/null || echo "unknown")
                echo "   Pod started: $POD_AGE"
              else
                echo "   No pods found!"
                exit 1
              fi
              
              echo ""
              echo "üîÑ Triggering pod restart for blocklist update..."
              echo "   Method: Delete existing pods (Deployment will recreate automatically)"
              
              # PodÂâäÈô§ÔºàDeployment„ÅåËá™ÂãïÁöÑ„Å´ÂÜç‰ΩúÊàêÔºâ- CronJobËá™Ë∫´„ÅØÈô§Â§ñ
              kubectl delete pods -n external-dns -l app=external-unbound,version=v2.0 --wait=false
              
              echo "‚úÖ Pod deletion initiated"
              echo ""
              echo "‚è≥ Waiting for DNS service to be ready..."
              echo "   Method: Simple pod status check"
              
              # Unbound„ÅÆPodÁä∂ÊÖãÁ¢∫Ë™ç
              WAIT_COUNT=0
              MAX_WAIT=60  # ÊúÄÂ§ß10ÂàÜÔºà10Áßí√ó60ÂõûÔºâ
              
              while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
                WAIT_COUNT=$((WAIT_COUNT + 1))
                echo "   Checking pod status... (attempt $WAIT_COUNT/$MAX_WAIT)"
                
                # ReadyÁä∂ÊÖã„ÅÆUnbound„Éù„ÉÉ„Éâ„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
                if kubectl get pods -n external-dns -l app=external-unbound | grep -q "1/1.*Running"; then
                  echo "   ‚úÖ DNS service pods are ready"
                  break
                fi
                
                sleep 10
              done
              
              if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
                echo "   ‚ùå DNS service failed to be ready after $((MAX_WAIT * 10)) seconds"
                exit 1
              fi
              
              # Êñ∞PodÊÉÖÂ†±ÂèñÂæóÔºàÁµ±Ë®àË°®Á§∫Áî®Ôºâ
              sleep 5
              NEW_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "unknown")
              
              # Êõ¥Êñ∞ÁµêÊûúÁ¢∫Ë™ç
              echo ""
              echo "üéâ Update completed! New pod status:"
              kubectl get pods -n external-dns -l app=external-unbound -o wide
              
              # Êñ∞„Åó„ÅÑ„Éñ„É≠„ÉÉ„ÇØÊï∞Á¢∫Ë™ç
              echo ""
              echo "üìä Updated blocklist status:"
              NEW_POD=$(kubectl get pods -n external-dns -l app=external-unbound -o jsonpath='{.items[0].metadata.name}')
              echo "   New Pod: $NEW_POD"
              
              # Init Container„É≠„Ç∞„Åã„Çâ„Éñ„É≠„ÉÉ„ÇØÊï∞ÂèñÂæóÔºàÊï∞ÁßíÂæÖ„Å§Ôºâ
              echo "   Waiting for init container completion..."
              sleep 30
              
              # Êñ∞Pod„ÅÆInit Container„ÅåÂÆå‰∫Ü„Åô„Çã„Åæ„ÅßÂæÖÊ©ü
              kubectl wait --for=condition=Initialized pod "$NEW_POD" -n external-dns --timeout=300s >/dev/null 2>&1 || true
              
              NEW_BLOCKED_DOMAINS=$(kubectl logs -n external-dns "$NEW_POD" -c blocklist-downloader 2>/dev/null | grep "üìä Total blocked domains:" | tail -1 | awk '{print $5}' 2>/dev/null || echo "pending")
              echo "   New blocked domains: $NEW_BLOCKED_DOMAINS"
              
              # DNSÂãï‰ΩúÁ¢∫Ë™ç
              echo ""
              echo "üîç Verifying DNS functionality:"
              if kubectl exec -n external-dns "$NEW_POD" -- dig @127.0.0.1 -p 5353 google.com +short +time=5 | grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" >/dev/null 2>&1; then
                echo "   ‚úÖ DNS resolution: Working"
              else
                echo "   ‚ùå DNS resolution: Failed"
                exit 1
              fi
              
              # „Éñ„É≠„ÉÉ„ÇØÊ©üËÉΩÁ¢∫Ë™ç
              if kubectl exec -n external-dns "$NEW_POD" -- dig @127.0.0.1 -p 5353 doubleclick.net +short +time=5 2>/dev/null | grep -E "(^$|NXDOMAIN|0\.0\.0\.0)" >/dev/null; then
                echo "   ‚úÖ Ad blocking: Working"
              else
                echo "   ‚ö†Ô∏è  Ad blocking: Different response (may be normal)"
              fi
              
              echo ""
              echo "=== Auto-update Summary ==="
              echo "üïí Completed at: $(date)"
              echo "üìä Previous domains: $BLOCKED_DOMAINS"
              echo "üìä Updated domains: $NEW_BLOCKED_DOMAINS"
              echo "üéØ Pod: $CURRENT_POD ‚Üí $NEW_POD"
              echo "‚úÖ Blocklist auto-update completed successfully"
              
            resources:
              requests:
                memory: "64Mi"
                cpu: "100m"
              limits:
                memory: "128Mi"
                cpu: "200m"
---
# ServiceAccount for CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater-sa
---
# ClusterRole with necessary permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: external-dns
  name: blocklist-updater
  labels:
    app: external-unbound
    component: updater-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "delete"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: blocklist-updater
  namespace: external-dns
  labels:
    app: external-unbound
    component: updater-rb
subjects:
- kind: ServiceAccount
  name: blocklist-updater
  namespace: external-dns
roleRef:
  kind: Role
  name: blocklist-updater
  apiGroup: rbac.authorization.k8s.io