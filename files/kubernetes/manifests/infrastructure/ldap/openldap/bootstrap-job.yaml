apiVersion: batch/v1
kind: Job
metadata:
  name: openldap-bootstrap
  namespace: openldap
  labels:
    app.kubernetes.io/name: openldap
    app.kubernetes.io/component: authentication
    app.kubernetes.io/part-of: authentication-infrastructure
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app.kubernetes.io/name: openldap-bootstrap
        app.kubernetes.io/component: authentication
    spec:
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: ubuntu:24.04
        command:
          - /bin/bash
          - -c
          - |
            set -e

            echo "=== OpenLDAP Bootstrap Job ==="
            echo "Timestamp: $(date)"

            # 必要なツールのインストール
            echo "Installing ldap-utils and gettext-base..."
            apt-get update -qq
            apt-get install -y -qq ldap-utils gettext-base

            # OpenLDAPの起動待機（Root DSEへの接続確認）
            echo "Waiting for OpenLDAP to be ready..."
            MAX_ATTEMPTS=120
            ATTEMPT=0

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              if ldapsearch -x -H ldap://openldap-ldap:389 \
                 -D "cn=admin,dc=kojigenba-srv,dc=com" \
                 -w "$LDAP_ADMIN_PASSWORD" \
                 -b "" -s base "(objectClass=*)" >/dev/null 2>&1; then
                echo "✓ OpenLDAP is ready!"
                sleep 5  # 安全のため少し待つ
                break
              fi
              ATTEMPT=$((ATTEMPT + 1))
              echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS - Waiting..."
              sleep 2
            done

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "ERROR: OpenLDAP did not become ready after $((MAX_ATTEMPTS * 2)) seconds"
              exit 1
            fi

            # LDIF処理（環境変数置換）
            # Note: envFromでSecret内の全ての環境変数が自動的に設定される
            # ユーザー固有の環境変数チェックは不要（JSON設定に依存）
            echo "Processing bootstrap LDIF..."

            envsubst < /bootstrap/bootstrap.ldif > /tmp/bootstrap-processed.ldif

            # デバッグ出力（パスワードハッシュはマスク）
            echo "Generated LDIF preview (passwords masked):"
            sed 's/userPassword:.*/userPassword: ***MASKED***/g; s/sambaNTPassword:.*/sambaNTPassword: ***MASKED***/g' \
              /tmp/bootstrap-processed.ldif | head -20
            echo "... (truncated)"

            # LDIF投入
            echo "Loading bootstrap data..."
            timeout 60 ldapadd -c -x -H ldap://openldap-ldap:389 \
              -D "cn=admin,dc=kojigenba-srv,dc=com" \
              -w "$LDAP_ADMIN_PASSWORD" \
              -f /tmp/bootstrap-processed.ldif 2>&1 | tee /tmp/ldapadd-output.log

            EXIT_CODE=${PIPESTATUS[0]}
            echo "ldapadd exit code: $EXIT_CODE"

            # ファイルから出力を読み込む
            LDAP_OUTPUT=$(cat /tmp/ldapadd-output.log)

            # Exit code 0 = Success
            # Exit code 68 = Already exists (許容)
            # Exit code 80 = Other LDAP error (許容 - -c オプションで続行するため)
            # Exit code 124 = timeout
            if [ $EXIT_CODE -eq 0 ] || echo "$LDAP_OUTPUT" | grep -q "Already exists"; then
              echo "✓ Bootstrap data loaded successfully (or already exists)!"

              # エラーがあるかチェック（既存エラーを除く）
              if echo "$LDAP_OUTPUT" | grep -q "^ldap_"; then
                echo "Note: Some entries may have already existed (expected on re-run)"
              fi
            else
              echo "ERROR: Bootstrap failed with exit code $EXIT_CODE"
              echo "Output was:"
              cat /tmp/ldapadd-output.log
              exit $EXIT_CODE
            fi

            # 既存エントリの更新（memberUid など）
            echo "Applying updates to existing entries..."
            if [ -f /bootstrap-update/update.ldif ]; then
              timeout 60 ldapmodify -c -x -H ldap://openldap-ldap:389 \
                -D "cn=admin,dc=kojigenba-srv,dc=com" \
                -w "$LDAP_ADMIN_PASSWORD" \
                -f /bootstrap-update/update.ldif 2>&1 | tee /tmp/ldapmodify-output.log

              UPDATE_EXIT_CODE=${PIPESTATUS[0]}
              echo "ldapmodify exit code: $UPDATE_EXIT_CODE"

              if [ $UPDATE_EXIT_CODE -eq 0 ]; then
                echo "✓ Updates applied successfully!"
              else
                echo "WARNING: Some updates may have failed (this is expected if entries don't exist yet)"
                cat /tmp/ldapmodify-output.log
              fi
            else
              echo "No update LDIF found, skipping..."
            fi

            # 確認
            echo "Verifying bootstrap..."
            ldapsearch -x -H ldap://openldap-ldap:389 \
              -D "cn=admin,dc=kojigenba-srv,dc=com" \
              -w "$LDAP_ADMIN_PASSWORD" \
              -b "dc=kojigenba-srv,dc=com" \
              -LLL "(objectClass=organizationalUnit)" dn

            echo "=== Bootstrap completed successfully ==="
        envFrom:
        - secretRef:
            name: openldap-secrets
        env:
        - name: LDAP_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: openldap-secrets
              key: admin_password
        volumeMounts:
        - name: bootstrap-config
          mountPath: /bootstrap
          readOnly: true
        - name: bootstrap-update-config
          mountPath: /bootstrap-update
          readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: bootstrap-config
        configMap:
          name: openldap-bootstrap-config
          defaultMode: 0444
      - name: bootstrap-update-config
        configMap:
          name: openldap-bootstrap-update-config
          defaultMode: 0444