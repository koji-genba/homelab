apiVersion: batch/v1
kind: Job
metadata:
  name: lldap-bootstrap
  namespace: lldap
  labels:
    app.kubernetes.io/name: lldap
    app.kubernetes.io/component: authentication
    app.kubernetes.io/part-of: authentication-infrastructure
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: lldap-bootstrap
        app.kubernetes.io/component: authentication
    spec:
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: nitnelave/lldap:latest
        command: ["/app/bootstrap.sh"]
        env:
        - name: LLDAP_URL
          value: "http://lldap-web:17170"
        - name: LLDAP_ADMIN_USERNAME
          value: "admin"
        - name: LLDAP_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: lldap-secrets
              key: admin_password
        - name: USER_CONFIGS_DIR
          value: "/bootstrap/user-configs"
        - name: GROUP_CONFIGS_DIR
          value: "/bootstrap/group-configs"
        - name: DO_CLEANUP
          value: "false"
        volumeMounts:
        - name: bootstrap-config
          mountPath: /bootstrap/user-configs/admin-user.json
          subPath: admin-user.json
          readOnly: true
        - name: bootstrap-config
          mountPath: /bootstrap/user-configs/testuser.json
          subPath: testuser.json
          readOnly: true
        - name: bootstrap-config
          mountPath: /bootstrap/group-configs/system-admins.json
          subPath: system-admins.json
          readOnly: true
        - name: bootstrap-config
          mountPath: /bootstrap/group-configs/system-users.json
          subPath: system-users.json
          readOnly: true
        - name: bootstrap-config
          mountPath: /bootstrap/group-configs/system-readonly.json
          subPath: system-readonly.json
          readOnly: true
      volumes:
      - name: bootstrap-config
        configMap:
          name: lldap-bootstrap-config
          defaultMode: 0444